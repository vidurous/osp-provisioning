# update all the base packages from the updates repository

cat > /etc/yum.repos.d/irondung.net.repo << 'EOF'
[rhel-7-server-rpms]
name=rhel-7-server-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-rpms
enabled=1
gpgcheck=0

[rhel-7-server-rh-common-rpms]
name=rhel-7-server-rh-common-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-rh-common-rpms
enabled=1
gpgcheck=0

[rhel-7-server-openstack-8-rpms]
name=rhel-7-server-openstack-8-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-openstack-8-rpms
enabled=1
gpgcheck=0

[rhel-7-server-openstack-8-director-rpms]
name=rhel-7-server-openstack-8-director-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-openstack-8-director-rpms
enabled=1
gpgcheck=0

[rhel-7-server-extras-rpms]
name=rhel-7-server-extras-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-extras-rpms
enabled=1
gpgcheck=0

[rhel-7-server-optional-rpms]
name=rhel-7-server-optional-rpms
baseurl=http://foreman.irondung.net:8120/repos/rhel-7-server-optional-rpms
enabled=1
gpgcheck=0

[puppetlabs-products]
name=puppetlabs-products
baseurl=http://foreman.irondung.net:8120/repos/puppetlabs-products
enabled=1
gpgcheck=0

[puppetlabs-deps]
name=puppetlabs-deps
baseurl=http://foreman.irondung.net:8120/repos/puppetlabs-deps
enabled=1
gpgcheck=0
EOF

sed -i 's/enabled=1/enabled=0/' /etc/yum/pluginconf.d/subscription-manager.conf
useradd stack
echo "stack:redhat"|chpasswd stack ;echo "stack ALL=(root) NOPASSWD:ALL" | tee
-a /etc/sudoers.d/stack
chmod 0440 /etc/sudoers.d/stack
export IP=`ip a|grep 192.168.|awk '{print $2}'|cut -d'/' -f1`
echo "$IP $HOSTNAME" >> /etc/hosts
cat > /etc/profile.d/instack.sh << 'EOF'
export IP=`ip a|grep 192.168.|awk '{print $2}'|cut -d'/' -f1`
EOF
mkdir /root/.ssh/
cat > /root/.ssh/authorized_keys << 'EOF'
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQC5jiyLaBzRg+zFwIcFhOCLF1Li+8rA8jJ+82+FTsSu+GrkjCW8uV1F2f/b2YN0QcNBPIw0Y3n3xhCC2p6JXnz8vmX0Nq3psLgKF2aHHEkNuQ1ciu859aL5ExC6uRd/cwHN/OS3oXcx98v9XCfRzP47QLg0Zfk5MU39MBs4/OIYGv0eBmsDb1inY0cW1fpWNxzCYTIK0aoDHVgxaKpRnhfs2gyy/C7Z5XjmJ07qoMhvkHxkZei61wWYpcI1VpkXMOKfalmr9hbTA2LzX3AVmjSAOq7Oj1/cLX4HLrj46aKScy+szSgb82jAU9XlI0Nvsti1WR3nIS0xUSpVkrWnKua5
aathomas@snotbox
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDS1mPnvHtsZjzHW20iw10PACUyWj1yHoHLH4JeYXzM4xpT5/OMd61qYd2vCyQ9wi4zEOs7IIfWsO5uIA9W91HlkDyoGbqAdyq3ozTTcADBao4J+oe+z9+I07tQ4GbJjgO7FPU/PHwtuF1qkCKisCAfnmbqwC0dYoiEy24zZ2qJJ1E0K/MN0fu86wBR9F960im9Y3Gt6CBBnOWzRPRYZj10302MG/XVqSv8ffYAWfFn080SOMsG41ur9ICrsY8VmoTS1c3aHhsy1zVHpiMq3yTJVpKbKZj/QEbuLVPxmhzwfT6Cf9Zxfv4QmW0cU0/hG6fK4v+2uh0/oIBEM7W+/IVD
root@foreman.irondung.net
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQCb+lUzRgi2U4x04Ba6pcmA8rGQjwgse9Cl1zP53WgmRL039pQEXt8gZ0zcWQFNBra8FdGKs1R5drae7lmVm4J37ic3wLeJJ9WIJkF30wNxRfb47b0R8Ylu/IYzDGULARNpou6uVV1ApSimN3uV2KK4bvQ5YKtMp4wOSpI9n1xyq0XO3We64o0p8Yw1lZ5L4ZcplHLvtctY6M+3kyGH+42fOb3mJNcoagv1u3imm8NABmfTg5oAYXuC8LMIGMNPH3hxORwPTBTwn5alO8lMFXgi9qEeMD2O4NgmGwLxS+Y3jLKlJEc37knpgHV/6Fcb81BKjCC3hPjQWdkPWoy8Y8Wb
aathomas@irondung.rdu.openstack.engineering.redhat.com
EOF
cat > /stack/.ssh/id_rsa.pub << 'EOF'
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQC5jiyLaBzRg+zFwIcFhOCLF1Li+8rA8jJ+82+FTsSu+GrkjCW8uV1F2f/b2YN0QcNBPIw0Y3n3xhCC2p6JXnz8vmX0Nq3psLgKF2aHHEkNuQ1ciu859aL5ExC6uRd/cwHN/OS3oXcx98v9XCfRzP47QLg0Zfk5MU39MBs4/OIYGv0eBmsDb1inY0cW1fpWNxzCYTIK0aoDHVgxaKpRnhfs2gyy/C7Z5XjmJ07qoMhvkHxkZei61wWYpcI1VpkXMOKfalmr9hbTA2LzX3AVmjSAOq7Oj1/cLX4HLrj46aKScy+szSgb82jAU9XlI0Nvsti1WR3nIS0xUSpVkrWnKua5
aathomas@snotbox
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQCyPq6IOY/1Orwcl0+QiSk99GU8pcvLTKirPtsXxQbdrVM21Je6w/Vm4VxJXmBCKOWThC+nDM04P0Udt8+GI4My+vlfJ8XyGUktd7lmKSwOOGevO1WQ93t9VvIp8BpGrcqOgPF9E6cYjn6JQ3lgMzxFvWZKhya7gK+YPG1leEXwAhJum945kcFjLkjbj8mran3GPHL1wfGHaNlYMpa29W5hDlsGdqviXHtXFowyM1Sp1mTcO8bcSjxDnBY0EHWxy9rZR/8dsOB4vtkJQ5o4A3quPKLk7LuYJNEnplm9rVYX0BUMPFZ+wjNfWitdj5Xba6NF2lCChAEUcMty7CcvgUTj
aathomas@bluward
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDIuTFaHbeK4iVS45CoaczYxSZwMv+SYmJDo2aVzjoGKqjmLx1lQBq3oDwL7tmiEje4KK9LUFoEs5x+PSuOAdRFWWFQruOmsk+EoWYOnkrEYen2E2pN0jUO2rHG0uZ7HzYRNNGNq1OYRDmb05b67jKALSJdXRhgWVP0C6S0QMrmt37zY4EOGHS1xgXT3alMkKVhgFqdttMkYS6qqcnKncWgRk+s6LucN9xohrelUXZLP3fxKPxpOSsLMgilDDa9N23HbHKiN1ZARQYxaLm3aRlxPqaLAbaGeGOji8SMT6NQpJHu8DKmlq5bnkWVAtjMpGq6u3YoPiNMBq9FDjickJqP
aathomas@T440s
ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDe2NYnIQGCOuRqvamOd9CjyKY5IAQ+w2SWY/SvLO0k35h/XibxVM+NihJgqwn6W2Svy4Ih6NCy8oXmMOfV38VjGkgTJzg3Km9Zr4yHZMyRuDBLhI5sY5aFnFjuSSvB4oKg4JQ59IxUvkoyQMJKuHoquZPRnaQPfmyemYr31RX1xLPx/Kf9Ux5dzBRuWY8l56EpkCHqY1/n0Wa/N7OaOgXUq7TjPR4TP7VZPH38kQ4AiMpVxFOSNN/8uav6q+3bg6Q3WB69fkYOcX4oXP/X9+fhlYFJ3JxRI/jGVSVQI/5eewmg54HIsEDOqZYBoMm/I8sg14+LEu4qsc2//zeibUTv
EOF
yum install git rsync -y
cd /root/ ; git clone git://github.com/vidurous/openstack-provisioning && cd
openstack-provisioning/ 
rsync -auv clean-answers.cfg ../
cd - ; rm -fr openstack-provisioning/
for x in `cat clean-answers.cfg`; do sed -i 's/$IP/'$IP'/' clean-answers.cfg ;
done
packstack --answer-file=clean-answers.cfg
yum install -y openstack-packstack
yum -t -y -e 0 update